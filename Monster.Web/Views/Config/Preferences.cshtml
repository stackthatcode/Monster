@using Monster.Web.Plumbing

@Html.Partial("_TopBrand")

<hr/>
<h1 class="mt-5 center">Configuration - Preferences</h1>
<p class="lead center">Choose settings to enable @GlobalConfig.AppName to properly synchronize</p>

<style>
    .form-group label { font-weight: 700; }
</style>

<p>@GlobalConfig.AppName is now ready for you to set your Preferences.
    When @GlobalConfig.AppName is running in Real-Time Sync Mode, it
    will produce a large volume of work. It is critical that you make 
    sure your Preferences match your business objectives.</p>

<style>
    #preferences .form-group { height: 120px; }
</style>
<div class="std-padding">
    <div class="card text-center">
        <div id="preferences" class="card-body left">

            <!-- Starting Date for Orders -->
            <div class="form-group">
                <label for="datepicker">Starting Date for Shopify Orders</label>

                <input id="datepicker" 
                       class="form-control"
                       placeholder="Choose a valid date..."
                       data-bind="value: SelectedStartingDate"
                       />

                <small id="datepickerHelp" class="form-text text-muted">
                    @GlobalConfig.AppName will only load Shopify Orders
                    that are created on or after this date into Acumatica.
                </small>
            </div>

            <!-- Time Zone -->
            <div class="form-group">
                <label for="timeZone">Acumatica Instance Time Zone</label>

                <select id="timeZone" class="form-control"
                        data-bind="value: SelectedTimeZone,
                                options: TimeZones,
                                optionsText: 'Name',
                                optionsValue: 'TimeZoneId',
                                optionsCaption: 'Choose...'">
                </select>
                
                <small id="timeZoneHelp" class="form-text text-muted">
                    In order to synchronize properly, @GlobalConfig.AppName 
                    needs to translate between time zones properly
                </small>
            </div>

            <!-- Item Class -->
            <div class="form-group">
                <label for="itemClass">Default Item Class</label>

                <select class="form-control"
                        id="itemClass"
                        data-bind="optionsCaption: 'Choose...',
                                value: SelectedItemClass,
                                options: ItemClasses,
                                optionsText: 'ItemClass'">
                </select>

                <small id="itemClassHelp" class="form-text text-muted">
                    @GlobalConfig.AppName will use this selection
                    when it creates Stock Items from Shopify Products
                </small>
            </div>

            <!-- Posting Class -->
            <div class="form-group">
                <label for="postingClass">Default Posting Class</label>

                <div data-bind="ifnot: SelectedPostingClass">
                    <input type="text"
                           id="postingClass"
                           class="form-control"
                           disabled="disabled"
                           value="(Select an Item Class that has a Posting Class)"/>
                </div>


                <div data-bind="if: SelectedPostingClass">
                    <input type="text"
                           id="postingClass"
                           class="form-control"
                           disabled="disabled"
                           data-bind="value: SelectedPostingClass"/>
                </div>

                <small id="postingClassHelp" class="form-text text-muted">
                    @GlobalConfig.AppName will use this selection
                    when it creates Stock Items from Shopify Products
                </small>
            </div>

            <!-- Payment Method -->
            <div class="form-group">
                <label for="paymentMethod">Payment Method</label>

                <select class="form-control"
                        id="paymentMethod"
                        data-bind="optionsCaption: 'Choose...',
                                    options: PaymentMethods,
                                    optionsText: 'PaymentMethod',
                                    value: SelectedPaymentMethod">
                </select>

                <small id="paymentMethodHelp" class="form-text text-muted">
                    @GlobalConfig.AppName will use this selection
                    when it creates Payments in Acumatica.
                </small>
            </div>

            <!-- Payment Cash Account -->
            <div class="form-group">
                <label for="cashAccountMethod">Payment Cash Account</label>

                <div data-bind="if: CashAccounts().length == 0">
                    <input type="text"
                           class="form-control"
                           disabled="disabled"
                           value="(Select a Payment Method that has a Cash Account)" />
                </div>

                <div data-bind="if: CashAccounts().length">
                    <select class="form-control"
                            id="cashAccountMethod"
                            data-bind="options: CashAccounts"></select>
                </div>

                <small id="cashAccountMethodHelp" class="form-text text-muted">
                    @GlobalConfig.AppName will use this selection
                    when it creates Payments in Acumatica.
                </small>
            </div>

            <!-- Tax Zone -->
            <div class="form-group">
                <label for="taxZone">Tax Zone</label>

                <select type="url"
                        class="form-control"
                        name="taxZone"
                        id="taxZone">
                    <option>ONLINE</option>
                </select>

                <small id="taxZoneHelp"
                       class="form-text text-muted">
                    @GlobalConfig.AppName uses this selection for sales tax
                    in Sales Orders and Credit Memos.
                </small>
            </div>

            <!-- Tax Category -->
            <div class="form-group">
                <label for="taxCategory">Tax Category</label>

                <select type="url"
                        class="form-control"
                        name="taxCategory"
                        id="taxCategory">
                    <option>ONLINE</option>
                </select>

                <small id="taxCategoryHelp"
                       class="form-text text-muted">
                    @GlobalConfig.AppName uses this selection for sales tax
                    in Sales Orders and Credit Memos.
                </small>
            </div>

            <!-- Tax ID -->
            <div class="form-group">
                <label for="taxId">Tax ID</label>

                <select type="url" class="form-control"
                        name="taxId" id="taxId">
                    <option>ONLINE</option>
                </select>

                <small id="taxIdHelp"
                       class="form-text text-muted">
                    @GlobalConfig.AppName uses this selection for sales tax
                    in Sales Orders and Credit Memos.
                </small>
            </div>
        </div>
        <div class="card-footer text-muted">
            @GlobalConfig.AppName Preferences Editor
        </div>
    </div>
</div>

<div class="std-padding-bottom center">
    <a href="@GlobalConfig.Url("Config/AcumaticaConnection")"
       class="btn btn-secondary btn-lg">
        <i class="fas fa-undo"></i> Previous Step
    </a>

    <a href="@GlobalConfig.Url("Config/Warehouses")"
       class="btn btn-success btn-lg">Go to Next Step
        <i class="fas fa-sign-in-alt"></i></a>
</div>

<script>
    var Monster = Monster || {};

    Monster.PreferencesModel = function () {
        var self = this;

        // Reference data
        self.TimeZones = ko.observableArray();
        self.ItemClasses = ko.observableArray();
        self.PaymentMethods = ko.observableArray();
        self.TaxIds = ko.observableArray();
        self.TaxCategories = ko.observableArray();
        self.TaxZones = ko.observableArray();
        self.CashAccounts = ko.observableArray(); // Updates when SelectedPaymentMethod changes

        // Selected options
        self.SelectedTimeZone = ko.observable();
        self.SelectedStartingDate = ko.observable();
        self.SelectedItemClass = ko.observable();
        self.SelectedPaymentMethod = ko.observable();
        self.SelectedCashAccount = ko.observable();
        self.SelectedTaxId = ko.observable();
        self.SelectedTaxCategory = ko.observable();
        self.SelectedTaxZone = ko.observable();
        self.SelectedCashAccount = ko.observable();

        self.SelectedPostingClass = ko.computed(function() {
            return self.SelectedItemClass()
                    ? self.SelectedItemClass().PostingClass : null;
        });
        
        self.SelectedPaymentMethod.subscribe(function () {
            if (self.SelectedPaymentMethod()) {
                self.CashAccounts(self.SelectedPaymentMethod().CashAccounts);
            } else {
                self.CashAccounts([]);
            }
        });


        self.Initialize = function () {
            $('#datepicker').datepicker({
                uiLibrary: 'bootstrap4'
            });

            flow.exec(
                function () {
                    var ajax = new Monster.Ajax();
                    ajax.HttpGet("Config/ReferenceData", this);
                },
                function (response) {
                    console.log(response);

                    self.TimeZones(response.timeZones);
                    self.ItemClasses(response.itemClasses);
                    self.PaymentMethods(response.paymentMethods);
                    self.CashAccounts([]);
                    self.TaxIds(response.taxIds);
                    self.TaxCategories(response.taxCategories);
                    self.TaxZones(response.taxZones);
                });
        };

        return self;
    };

    var model = new Monster.PreferencesModel();
    model.Initialize();
    ko.applyBindings(model);
</script>

