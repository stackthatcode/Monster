
<style>
    .order-grid { font-size: 0.8em; }
    .order-grid td:nth-child(1), .order-grid th:nth-child(1) { text-align: left;}
    .order-grid td:nth-child(2), .order-grid th:nth-child(2) { text-align: left;}
    .order-grid td:nth-child(3), .order-grid th:nth-child(3) { text-align: right;}
    .order-grid td:nth-child(4), .order-grid th:nth-child(4) { text-align: right;}
    .order-grid td:nth-child(5), .order-grid th:nth-child(5) { text-align: right;}
    .order-grid td:nth-child(6), .order-grid th:nth-child(6) { text-align: right;}
    .order-grid td:nth-child(7), .order-grid th:nth-child(7) { text-align: right;}
    .order-grid td:nth-child(8), .order-grid th:nth-child(8) { text-align: right;}

    .order-link { font-weight: 700; }
    .order-analyzer { font-size: 0.8em; }
    .order-analyzer td:nth-child(1) { color: #666; width: 25%; text-align: left; font-weight: 700; }
    .order-analyzer td:nth-child(2) { width: 20%; text-align: right; font-weight: 400; }
    .order-analyzer td:nth-child(4) { color: #666; width: 25%;text-align: left; font-weight: 700; }
    .order-analyzer td:nth-child(5) { width: 20%; text-align: right; font-weight: 400; }

    .filter-control .btn, .filter-control input { font-size: 0.9em;}
</style>

<div class="card std-pad-sm">
    <div class="card-title-interface">
        Order Synchronization Analyzer
    </div>
    
    <div class="card-body std-pad-sm-side">
        <div data-bind="visible: HideDrilldown">
            <div data-bind="template: { name: 'Order-Analyzer-Grid' }"></div>
        </div>

        <div data-bind="visible: ShowDrilldown">
            <div data-bind="if: OrderAnalysis">
                <div data-bind="template: { name: 'Order-Analyzer-Drilldown', data: OrderAnalysis }"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="Order-Analyzer-Grid">
    <div id="order-grid">
        <!-- Filtering -->
        <div class="row">
            <div class="col-sm-8">
                <div class="input-group mb-3 filter-control">
                    <input type="text" class="form-control" data-bind="value: SearchText"
                           placeholder="Search by Shopify Order Number or ID, Acumatica Sales Order ID"
                           aria-label="Search by Shopify Order Number or ID, Acumatica Sales Order ID"
                           maxlength="25" />

                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="button" data-bind="click: FilterOrdersClick">
                            Filter Orders <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-sm-4 right">
                <div data-bind="template: { name: 'Monster-Paging-Widget', data: PagingWidget }"></div>
            </div>
        </div>

        <table class="table table-striped table-hover order-grid">
            <thead>
            <tr style="color: #777;">
                <th scope="col">Shopify<br />Order Nbr</th>
                <th scope="col">Acumatica<br /> Sales Order</th>
                <th scope="col">Shopify<br /> Order Total</th>
                <th scope="col">Shopify<br /> Net Payment</th>
                <th scope="col">Acumatica<br /> Order Payment</th>
                <th scope="col">Acumatica<br /> Net Payment</th>
                <th scope="col">Acumatica<br /> Invoice Total</th>
                <th scope="col">Outstanding<br /> Balance</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: Grid">
                <tr data-bind="click: $parent.OrderClick">
                    <td data-bind="text: ShopifyOrderNbr"></td>
                    <td data-bind="text: AcumaticaSalesOrderNbr"></td>
                    <td data-bind="text: ShopifyOrderTotal"></td>
                    <td data-bind="text: ShopifyNetPayment"></td>
                    <td data-bind="text: AcumaticaOrderPayment"></td>
                    <td data-bind="text: AcumaticaNetPayment"></td>
                    <td data-bind="text: AcumaticaInvoiceTotal"></td>
                    <td data-bind="text: OutstandingBalance"></td>
                </tr>
            </tbody>
        </table>
    </div>
</script>

<script type="text/html" id="Order-Analyzer-Drilldown">
    <div class="center std-pad-side" style="width: 100%;">
        <a href="#" class="btn btn-secondary btn-sm" data-bind="click: function() { $parent.ShowDrilldown(false); }">
            Back to Results <i class="fas fa-undo"></i>
        </a>
        <div style="height: 20px;"></div>
        <table class="table order-analyzer">
            <tr>
                <td>Shopify Order Name</td>
                <td><a class="order-link" href="#" target="_blank"
                       data-bind="text: ShopifyOrderNbr, attr: { href: ShopifyOrderHref }"></a></td>
                <td> </td>
                <td>Acumatica Order ID</td>
                <td><a class="order-link" href="#" 
                       data-bind="text: AcumaticaSalesOrderNbr, attr: { href: AcumaticaSalesOrderHref }"></a></td>
            </tr>
            <tr>
                <td>Shopify Order ID</td>
                <td><a class="order-link" href="#" target="_blank" 
                       data-bind="text: ShopifyOrderId, attr: { href: ShopifyOrderHref }"></a></td>
                <td> </td>
                <td></td>
                <td></td>
            </tr>
            <tr><td colspan="5"></td></tr>

            <tr>
                <td>Shopify Total Line Price</td>
                <td data-bind="text: ShopifyTotalLinePrice"></td>
                <td> </td>
                <td>Acumatica Order Line Total</td>
                <td data-bind="text: AcumaticaOrderLineTotal"></td>
            </tr>
            <tr>
                <td>Shopify Shipping Price</td>
                <td data-bind="text: ShopifyShippingPriceTotal">/td>
                <td> </td>
                <td>Acumatica Order Freight</td>
                <td data-bind="text: AcumaticaOrderFreight"></td>
            </tr>
            <tr>
                <td>Shopify Total Tax</td>
                <td data-bind="text: ShopifyTotalTax"></td>
                <td> </td>
                <td>Acumatica Order Tax</td>
                <td data-bind="text: AcumaticaTaxTotal"></td>
            </tr>
            <tr>
                <td>Shopify Order Total</td>
                <td data-bind="text: ShopifyOrderTotal"></td>
                <td> </td>
                <td>Acumatica Order Total</td>
                <td data-bind="text: AcumaticaOrderTotal"></td>
            </tr>
            <tr><td colspan="5"></td></tr>

            <tr>
                <td>Shopify Order Payment Total</td>
                <td data-bind="text: ShopifyOrderPayment"></td>
                <td> </td>
                <td>Acumatica Payment Total</td>
                <td data-bind="text: AcumaticaPaymentTotal"></td>
            </tr>
            <tr>
                <td>Shopify Refund Payment Total</td>
                <td data-bind="text: ShopifyRefundPayment"></td>
                <td> </td>
                <td>Acumatica Refund Payment Totals</td>
                <td data-bind="text: AcumaticaRefundPaymentTotal"></td>
            </tr>
            <tr>
                <td>Shopify Net Payment Total</td>
                <td data-bind="text: ShopifyNetPayment"></td>
                <td> </td>
                <td>Acumatica Net Payment Total</td>
                <td data-bind="text: AcumaticaNetPaymentTotal"></td>
            </tr>
            <tr><td colspan="5"></td></tr>

            <tr>
                <td>Shopify Refund Item Total</td>
                <td data-bind="text: ShopifyRefundItemTotal"></td>
                <td> </td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>Shopify Refund Shipping Total</td>
                <td data-bind="text: ShopifyRefundShippingTotal"></td>
                <td> </td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>Shopify Refund Tax Total</td>
                <td data-bind="text: ShopifyRefundTaxTotal"></td>
                <td> </td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>Shopify Refund Credit Total</td>
                <td data-bind="text: ShopifyCreditTotal"></td>
                <td> </td>
                <td>Acumatica Refund Credit Total</td>
                <td data-bind="text: AcumaticaRefundCreditTotal"></td>
            </tr>
            <tr>
                <td>Shopify Refund Debit Total</td>
                <td data-bind="text: ShopifyDebitTotal"></td>
                <td> </td>
                <td>Acumatica Refund Debit Total</td>
                <td data-bind="text: AcumaticaRefundDebitTotal"></td>
            </tr>
            <tr>
                <td>Shopify Refund Total</td>
                <td data-bind="text: ShopifyRefundTotal"></td>
                <td> </td>
                <td>Acumatica Credit/Debit Total</td>
                <td data-bind="text: AcumaticaCreditDebitMemoTotal"></td>
            </tr>
            <tr><td colspan="5"></td></tr>

            <tr>
                <td></td>
                <td></td>
                <td> </td>
                <td>Acumatica Invoice Tax Total</td>
                <td data-bind="text: AcumaticaInvoiceTaxTotal"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td> </td>
                <td>Acumatica Invoice Total</td>
                <td data-bind="text: AcumaticaInvoiceTotal"></td>
            </tr>
        </table>
    </div>
</script>

<script>
    var Monster = Monster || {};

    Monster.OrderSyncModel = function() {
        var self = this;

        // Grid stuff...
        //
        self.SearchText = ko.observable();
        self.Grid = ko.observableArray([]);

        self.ScrollToTop = function() {
            $('html,body').animate({ scrollTop: 0 });
        };
        self.PagingWidget = new MonsterWidgets.PagingWidget();
        self.PagingWidget.Callback = function() {
            self.RefreshGrid(self.ScrollToTop);
        };

        // Order drill down...
        //
        self.OrderAnalysis = ko.observable();
        self.ShowDrilldown = ko.observable(false);
        self.HideDrilldown = ko.computed(function() { return !self.ShowDrilldown(); });

        self.FilterOrdersClick = function() {
            self.RefreshGrid();
        };

        self.RefreshGrid = function(callback) {
            flow.exec(function() {
                    var ajax = new Monster.Ajax();
                    var request = {
                        PageNumber: self.PagingWidget.PageNumber(),
                        PageSize: self.PagingWidget.PageSize(),
                        SearchText: self.SearchText(),
                    };
                    ajax.HttpPost("/Analysis/OrderSyncResults", request, this);
                },
                function (response) {
                    self.Grid(response.Grid);
                    self.PagingWidget.RecordCount(response.Count);
                });
        };
        
        self.Initialize = function() { self.RefreshGrid(); };

        self.OrderClick = function (item) {
            flow.exec(function () {
                    console.log(item);

                    var ajax = new Monster.Ajax();
                    ajax.HttpGet("/Analysis/OrderAnalysis?shopifyOrderId=" + item.ShopifyOrderId, this);
                },
                function (response) {
                    self.OrderAnalysis(response);
                    self.ShowDrilldown(true);
                });
        };

        return self;
    };

    var model = new Monster.OrderSyncModel();
    ko.applyBindings(model);
    model.Initialize();
</script>

